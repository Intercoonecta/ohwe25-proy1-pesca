---
title: "Captura incidental de peces de pico en la pesquería de atún tropical"
author: "Héctor Villalobos"
format: 
  gfm:
    toc: false
editor: visual
---

## Cargar paquetes

Para este tutorial requerimos tres paquetes:

```{r}
library(sp)         # Clases y métodos para datos espaciales
library(lubridate)  # Manipulación fácil de fechas 
library(PBSmapping) # Mapeo de datos pesqueros y herramientas de análisis espaciales
library(raster)
library(satin)
```

## Importar datos

Los datos descargados y ya descomprimidos se encuentran en la carpeta `data` de este tutorial. Usamos la función `read.csv()` que solo requiere especificar la ruta y nombre del archivo.

```{r}
pic <- read.csv("./data/PublicPSSharkSetType.csv")
```

Podemos explorar los datos con la función `head()` que muestra los primeros registros de estos. El contenido de cada cada columna puede consultarse en el archivo `PSBillfish-Picudos.pdf` mencionado antes.

```{r}
head(pic)
```

## Simplificar los datos

Dado que tenemos 32 años de datos a escala mensual para tres indicadores de pesca, vamos a agregar los tipos de indicador por trimestre. Además, nos concentraremos en los cuatro años más recientes.

```{r}
# Primero conservamos solamente los años 2021-2024
pic <- pic[pic$Year > 2020, ]

# agregamos los tipos de indicador
pic <- aggregate(pic[, 6:ncol(pic)], by = list(year = pic$Year, month = pic$Month, 
                                        lat = pic$LatC1, lon = pic$LonC1), sum)

#pic$fecha <- strptime(paste(pic$year, pic$month, 1, sep ="-"), format = "%Y-%m-%d")
#pic$qtr <- quarter(pic$fecha)

# agregar por trimestre
#pic <- aggregate(pic[, 5:12], by = list(year = pic$year, qtr = pic$qtr, 
```

```{r}
colSums(pic[, 6:25])

plot(pic$lon, pic$lat)
```

```{r}
# Mapa donde hubo captura para FAL
plot(pic$lon[pic$FALn > 0], pic$lat[pic$FALn > 0], pch = 16, col = rgb(0, 0, 1, 0.3))
```

```{r}
# Mapa donde hubo captura para FAL
plot(pic$lon[pic$FALn == 0], pic$lat[pic$FALn == 0], pch = 16, col = rgb(1, 0, 0, 0.3))
```

```{r}
library(satin)
copdata <- read.cmems("D:/ohwe2025/cmems_mod_glo_phy_my_0.083deg_P1M-m_1764099561632.nc")



```

```{r}
plot(copdata$thetao)

```

thetao.mean \<- thetao

```{r}
#thetao <- climatology(copdata) 
#thetao.mean <- thetao

#thetao.mean@data <- thetao@data[ , , 2]

#saveRDS(thetao.mean, "thetao.rds" )

```

Cargar temperaturas promedio 2021-2024

```{r}
thetao <- readRDS("./data/thetao.rds")
dim(thetao@data) <- c(dim(thetao@data), 1)
plot(thetao)
```

```{r}
plot(thetao, period = 2)
```

```{r}

# Definir el área de interés (pueden ser todos negativos si lo necesitas)
lonMin <- -150
lonMax <- -71
latMin <- -29
latMax <- 33
# Calcular número de filas y columnas: 1 píxel por grado
nrows <- latMax - latMin   # diferencia en grados de latitud
ncols <- lonMax - lonMin   # diferencia en grados de longitud
# Crear el raster vacío
r <- raster(nrows = nrows, ncols = ncols,
            xmn = lonMin, xmx = lonMax,
            ymn = latMin, ymx = latMax,
            crs = CRS("+proj=longlat +datum=WGS84"))
# Asignar valores NA
values(r) <- NA
# Ver resumen
r
# Graficar
plot(r, main = "Raster vacío definido por coordenadas")

```

```{r}
library(terra)

## copia de thetao para guardar datos reescalados
thetao1 <- thetao

## resample
xt2 <- ext(c(range(thetao1@lon), range(thetao1@lat)))

 a <- thetao1@data[ , , 1]
 a <- rast(a, extent = xt2)
 a2 <- raster(a) ## <- esto resuelve el error
 b <- resample(x = a2, y = r)
 thetao1@data[, , i] <- as.matrix(b, wide = TRUE) ## Aqui el "i" genera problemas!
  

plot(thetao1)
```

Con esto pasamos de 214,760 registros en la base original a sólo 18,009 después de simplificar.

```{r}
head(pic)
```

## Mapas de las capturas incidentales

Ahora podemos graficar la información simplificada por especie, primero sin considerar el año o trimestre.

```{r}
library(maps)  # Dibujar mapas

spp <- names(pic)[6:12]

for(sp in spp){
  plot(pic$lon[pic[, sp] > 0], pic$lat[pic[, sp] > 0], 
       asp = 1, main = sp, pch = 16, col = rgb(1, 0, 0, 0.2),
       xlab = "longitud", ylab = "latitud", las = 1)
  map("world", fill = TRUE, col = "grey90", main = "", 
      lwd = 0.5, add = TRUE)
  box()
}
```

Podemos obtener figuras más elaboradas con ayuda del paquete `PBSmapping`. Antes cargaremos un mapa del noroeste de México incluido en el paquete `satin`.

```{r}
library(satin)
 data(dmap)
detach(package:satin)
```

```{r}
# Queremos acomodar 16 mapas en una misma figura, los años en 
cyq <- expand.grid(1:4, 2021:2024)
names(cyq) <- c("qtr", "year")

xaxs2 <- c("n", "n", "n", "n",
           "n", "n", "n", "n",
           "n", "n", "n", "n",
           "s", "n", "s", "n")

yaxs2 <- c("n", "n", "n", "n",
           "s", "n", "n", "n",
           "n", "n", "n", "n",
           "s", "n", "n", "n")

# Ejemplo: Capturas incidentales de Marlin azul (BUM) 
# por trimestre para 2021-2024 
layout(matrix(1:16, ncol = 4, byrow = TRUE))
par(oma = c(4.5, 4.5, 1, 3), mar = c(0, 0, 0, 0))

for(i in 1:16){
  plot(dmap, axes = TRUE, ylim = c(22, 28), xlim = c(-115, -109), 
       col = "grey90", main = "", las = 1, lwd = 0.5, border = "grey",
       xaxt = xaxs2[i], yaxt = yaxs2[i])
  box(); text(-108, 27, paste(cyq$year[i], "_Q", cyq$qtr[i], sep =""))
  
  dat <- pic[pic$year == cyq$year[i] & pic$qtr == cyq$qtr[i], c('lon', 'lat', 'BUM')]
  names(dat) <- c("X", "Y", "Z")
  n <- nrow(dat)
  if(n > 0){
    dat <- data.frame(EID = 1:n, dat)
    class(dat) <- c("EventData", "data.frame")
    addBubbles(dat, legend.pos = NULL, z.max = 63, max.size = 0.6, 
               symbol.bg = rgb(1, 0, 0, 0.3))
  }
}

```
